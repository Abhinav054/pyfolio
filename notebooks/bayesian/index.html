<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Quantopian Inc.">
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Bayesian analysis - pyfolio</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <link href="../../extra.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../..">pyfolio</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../..">Overview</a>
                            </li>
                            <li >
                                <a href="../../whatsnew/">Releases</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tutorial <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../single_stock_example/">Single stock</a>
</li>
                                    
<li >
    <a href="../zipline_algo_example/">Zipline algorithm</a>
</li>
                                    
<li class="active">
    <a href="./">Bayesian analysis</a>
</li>
                                    
<li >
    <a href="../sector_mappings_example/">Sector analysis</a>
</li>
                                    
<li >
    <a href="../round_trip_tear_sheet_example/">Round trip analysis</a>
</li>
                                    
<li >
    <a href="../slippage_example/">Slippage analysis</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../zipline_algo_example/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../sector_mappings_example/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/quantopian/pyfolio/edit/master/docs/notebooks/bayesian.md"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#bayesian-performance-analysis-example-in-pyfolio">Bayesian performance analysis example in pyfolio</a></li>
            <li><a href="#import-pyfolio">Import pyfolio</a></li>
            <li><a href="#fetch-the-daily-returns-for-a-stock">Fetch the daily returns for a stock</a></li>
            <li><a href="#create-bayesian-tear-sheet">Create Bayesian tear sheet</a></li>
            <li><a href="#running-models-directly">Running models directly</a></li>
            <li><a href="#further-reading">Further reading</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="bayesian-performance-analysis-example-in-pyfolio">Bayesian performance analysis example in pyfolio</h1>
<p>There are a few advanced analysis methods in pyfolio based on Bayesian statistics. </p>
<p>The main benefit of these methods is <strong>uncertainty quantification</strong>. All the traditional measures of performance, like the Sharpe ratio, are just single numbers. These estimates are noisy because they have been computed over a limited number of data points. So how much can you trust these numbers? You don't know because there is no sense of uncertainty. That is where Bayesian statistics helps as instead of single values, we are dealing with probability distributions that assign degrees of belief to all possible parameter values.</p>
<p>Lets create the Bayesian tear sheet. Under the hood this is running MCMC sampling in <a href="http://pymc-devs.github.io/pymc3/">PyMC3</a> to estimate the posteriors which can take quite a while (that's the reason why we don't generate this by default in <code>create_full_tear_sheet</code>).</p>
<h2 id="import-pyfolio">Import pyfolio</h2>
<pre><code class="python">%matplotlib inline
import pyfolio as pf
</code></pre>

<h2 id="fetch-the-daily-returns-for-a-stock">Fetch the daily returns for a stock</h2>
<pre><code class="python">stock_rets = pf.utils.get_symbol_rets('FB')
</code></pre>

<h2 id="create-bayesian-tear-sheet">Create Bayesian tear sheet</h2>
<pre><code class="python">out_of_sample = stock_rets.index[-40]
</code></pre>

<pre><code class="python">pf.create_bayesian_tear_sheet(stock_rets, live_start_date=out_of_sample)
</code></pre>

<pre><code>Running T model


WARNING (theano.gof.compilelock): Overriding existing lock by dead process '23486' (I am process '24728')


Applied log-transform to volatility and added transformed volatility_log to model.
Applied log-transform to nu_minus_two and added transformed nu_minus_two_log to model.
 [-----------------100%-----------------] 2000 of 2000 complete in 14.8 sec
Finished T model (required 279.00 seconds).

Running BEST model
Applied interval-transform to group1_std and added transformed group1_std_interval to model.
Applied interval-transform to group2_std and added transformed group2_std_interval to model.
Applied log-transform to nu_minus_two and added transformed nu_minus_two_log to model.
 [-----------------100%-----------------] 2000 of 2000 complete in 12.6 sec
Finished BEST model (required 132.06 seconds).

Finished plotting Bayesian cone (required 0.21 seconds).


/home/wiecki/miniconda3/lib/python3.5/site-packages/matplotlib/axes/_axes.py:519: UserWarning: No labelled objects found. Use label='...' kwarg on individual plots.
  warnings.warn("No labelled objects found. "



Finished plotting BEST results (required 1.45 seconds).

Finished computing Bayesian predictions (required 0.26 seconds).

Finished plotting Bayesian VaRs estimate (required 0.12 seconds).

Running alpha beta model
Applied log-transform to sigma and added transformed sigma_log to model.
Applied log-transform to nu_minus_two and added transformed nu_minus_two_log to model.
 [-----------------100%-----------------] 2000 of 2000 complete in 7.2 sec
Finished running alpha beta model (required 130.28 seconds).

Finished plotting alpha beta model (required 0.24 seconds).

Total runtime was 543.62 seconds.
</code></pre>
<p><img alt="png" src="../bayesian_files/bayesian_7_5.png" /></p>
<p>Lets go through these row by row:</p>
<ul>
<li>The first one is the Bayesian cone plot that is the result of a summer internship project of Sepideh Sadeghi here at Quantopian. It's similar to the cone plot you already saw in the tear sheet above but has two critical additions: (i) it takes uncertainty into account (i.e. a short backtest length will result in a wider cone), and (ii) it does not assume normality of returns but instead uses a <a href="https://en.wikipedia.org/wiki/Student%27s_t-distribution">Student-T distribution</a> with heavier tails.</li>
<li>The next row compares mean returns of the in-sample (backest) and out-of-sample or OOS (forward) period. As you can see, mean returns are not a single number but a (posterior) distribution that gives us an indication of how certain we can be in our estimates. The green distribution on the left side is much wider, representing our increased uncertainty due to having less OOS data. We can then calculate the difference between these two distributions as shown on the right side. The grey lines denote the 2.5% and 97.5% percentiles. Intuitively, if the right grey line is lower than 0 you can say that with probability &gt; 97.5% the OOS mean returns are below what is suggested by the backtest. The model used here is called <a href="http://www.indiana.edu/~kruschke/BEST/BEST.pdf">BEST</a> and was developed by John Kruschke.</li>
<li>The next couple of rows follow the same pattern but are an estimate of annual volatility, Sharpe ratio and their respective differences.</li>
<li>The 5th row shows the effect size or the difference of means normalized by the standard deviation and gives you a general sense how far apart the two distributions are. Intuitively, even if the means are significantly different, it may not be very meaningful if the standard deviation is huge amounting to a tiny difference of the two returns distributions.</li>
<li>The 6th row shows predicted returns (based on the backtest) for tomorrow, and 5 days from now. The blue line indicates the probability of losing more than 5% of your portfolio value and can be interpeted as a Bayesian VaR estimate.</li>
<li>The 7th row shows a Bayesian estimate of annual alpha and beta. In addition to uncertainty estimates, this model, like all above ones, assumes returns to be T-distributed which leads to more robust estimates than a standard linear regression would.  The default benchmark is the S&amp;P500.  Alternatively, users may use the Fama-French model as a bunchmark by setting benchmark_rets="Fama-French".  </li>
<li>By default, stoch_vol=False because running the stochastic volatility model is computationally expensive.</li>
<li>Only the most recent 400 days of returns are used when computing the stochastic volatility model.  This is to minimize computational time.</li>
</ul>
<h2 id="running-models-directly">Running models directly</h2>
<p>You can also run individual models. All models can be found in <code>pyfolio.bayesian</code> and run via the <code>run_model</code> function.</p>
<pre><code class="python">help(pf.bayesian.run_model)
</code></pre>

<pre><code>Help on function run_model in module pyfolio.bayesian:

run_model(model, returns_train, returns_test=None, bmark=None, samples=500, ppc=False)
    Run one of the Bayesian models.

    Parameters
    ----------
    model : {'alpha_beta', 't', 'normal', 'best'}
        Which model to run
    returns_train : pd.Series
        Timeseries of simple returns
    returns_test : pd.Series (optional)
        Out-of-sample returns. Datetimes in returns_test will be added to
        returns_train as missing values and predictions will be generated
        for them.
    bmark : pd.Series or pd.DataFrame (optional)
        Only used for alpha_beta to estimate regression coefficients.
        If bmark has more recent returns than returns_train, these dates
        will be treated as missing values and predictions will be
        generated for them taking market correlations into account.
    samples : int (optional)
        Number of posterior samples to draw.
    ppc : boolean (optional)
        Whether to run a posterior predictive check. Will generate
        samples of length returns_test.  Returns a second argument
        that contains the PPC of shape samples x len(returns_test).

    Returns
    -------
    trace : pymc3.sampling.BaseTrace object
        A PyMC3 trace object that contains samples for each parameter
        of the posterior.

    ppc : numpy.array (if ppc==True)
       PPC of shape samples x len(returns_test).
</code></pre>
<p>For example, to run a model that assumes returns to be normally distributed, you can call:</p>
<pre><code class="python"># Run model that assumes returns to be T-distributed
trace = pf.bayesian.run_model('t', stock_rets)
</code></pre>

<pre><code>Applied log-transform to volatility and added transformed volatility_log to model.
Applied log-transform to nu_minus_two and added transformed nu_minus_two_log to model.
 [-----------------100%-----------------] 500 of 500 complete in 1.9 sec
</code></pre>
<p>The returned trace object can be directly inquired. For example might we ask what the probability of the Sharpe ratio being larger than 0 is by checking what percentage of posterior samples of the Sharpe ratio are &gt; 0:</p>
<pre><code class="python"># Check what frequency of samples from the sharpe posterior are above 0.
print('Probability of Sharpe ratio &gt; 0 = {:3}%'.format((trace['sharpe'] &gt; 0).mean() * 100))
</code></pre>

<pre><code>Probability of Sharpe ratio &gt; 0 = 92.0%
</code></pre>
<p>But we can also interact with it like with any other <code>pymc3</code> trace:</p>
<pre><code class="python">import pymc3 as pm
pm.traceplot(trace);
</code></pre>

<p><img alt="png" src="../bayesian_files/bayesian_16_0.png" /></p>
<h2 id="further-reading">Further reading</h2>
<p>For more information on Bayesian statistics, check out these resources:</p>
<ul>
<li><a href="http://blog.quantopian.com/bayesian-cone/">A blog post about the Bayesian models with Sepideh Sadeghi</a></li>
<li><a href="http://twiecki.github.io/">My personal blog on Bayesian modeling</a></li>
<li>A talk I gave in Singapore on <a href="http://blog.quantopian.com/probabilistic-programming-for-non-statisticians/">Probabilistic Programming in Quantitative Finance</a></li>
<li>A series of IPython notebooks on <a href="https://github.com/CamDavidsonPilon/Probabilistic-Programming-and-Bayesian-Methods-for-Hackers">Bayesian Methods for Hackers</a>.</li>
</ul></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"next": 78, "previous": 80, "help": 191, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
